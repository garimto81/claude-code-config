#!/bin/bash
#
# PR ìƒì„± í—¬í¼ ìŠ¤í¬ë¦½íŠ¸
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Phase ì™„ë£Œ ì»¤ë°‹ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ìœ¼ë¡œ PRì„ ìƒì„±í•©ë‹ˆë‹¤.
#
# Usage:
#     bash scripts/create-phase-pr.sh [commit_hash]
#
#     # ìµœì‹  ì»¤ë°‹ ê¸°ë°˜ PR ìƒì„±
#     bash scripts/create-phase-pr.sh
#
#     # íŠ¹ì • ì»¤ë°‹ ê¸°ë°˜ PR ìƒì„±
#     bash scripts/create-phase-pr.sh abc123
#
# ìš”êµ¬ì‚¬í•­:
#     - gh CLI ì„¤ì¹˜ í•„ìˆ˜ (https://cli.github.com/)
#     - Git ì €ì¥ì†Œ ë‚´ì—ì„œ ì‹¤í–‰
#     - í˜„ì¬ ë¸Œëœì¹˜ê°€ feature/* ë¸Œëœì¹˜ì—¬ì•¼ í•¨

set -euo pipefail

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ë¡œê¹… í•¨ìˆ˜
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# gh CLI ì„¤ì¹˜ í™•ì¸
check_gh_cli() {
    if ! command -v gh &> /dev/null; then
        log_error "gh CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_info "ì„¤ì¹˜: https://cli.github.com/"
        exit 1
    fi
    log_success "gh CLI í™•ì¸ ì™„ë£Œ"
}

# Git ì €ì¥ì†Œ í™•ì¸
check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        log_error "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤."
        exit 1
    fi
    log_success "Git ì €ì¥ì†Œ í™•ì¸ ì™„ë£Œ"
}

# Phase ì™„ë£Œ ê°ì§€
detect_phase_completion() {
    local commit_hash="${1:-HEAD}"

    log_info "Phase ì™„ë£Œ ê°ì§€ ì¤‘... (ì»¤ë°‹: $commit_hash)"

    # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    if ! python scripts/check-phase-completion.py "$commit_hash" > /tmp/phase_info.json 2>/dev/null; then
        log_warning "Phase ì™„ë£Œ ì»¤ë°‹ì´ ì•„ë‹™ë‹ˆë‹¤."
        cat /tmp/phase_info.json 2>/dev/null || true
        exit 1
    fi

    log_success "Phase ì™„ë£Œ ê°ì§€ ì„±ê³µ"
    cat /tmp/phase_info.json
}

# PR ì¡´ì¬ ì—¬ë¶€ í™•ì¸
check_existing_pr() {
    local branch_name="$1"

    log_info "ê¸°ì¡´ PR í™•ì¸ ì¤‘... (ë¸Œëœì¹˜: $branch_name)"

    local pr_number
    pr_number=$(gh pr list --head "$branch_name" --json number --jq '.[0].number' 2>/dev/null || echo "")

    if [ -n "$pr_number" ]; then
        log_warning "ì´ë¯¸ PRì´ ì¡´ì¬í•©ë‹ˆë‹¤: #$pr_number"
        log_info "PR URL: $(gh pr view "$pr_number" --json url --jq '.url')"
        return 0
    else
        log_info "ê¸°ì¡´ PR ì—†ìŒ"
        return 1
    fi
}

# PR ì œëª© ìƒì„±
generate_pr_title() {
    local phase_num="$1"
    local prd_num="$2"
    local commit_msg="$3"

    # ì»¤ë°‹ ë©”ì‹œì§€ ì²« ì¤„ì—ì„œ type: ì´í›„ ì¶”ì¶œ
    local subject
    subject=$(echo "$commit_msg" | head -1 | sed 's/^.*: //')

    if [ "$phase_num" != "null" ] && [ "$phase_num" != "unknown" ]; then
        echo "[PRD-$prd_num] Phase $phase_num: $subject"
    else
        echo "[PRD-$prd_num] $subject"
    fi
}

# PR ë³¸ë¬¸ ìƒì„±
generate_pr_body() {
    local phase_num="$1"
    local prd_num="$2"
    local version="$3"
    local branch_name="$4"
    local commit_msg="$5"

    cat <<EOF
## Phase Completion Summary

- **PRD**: PRD-$prd_num
- **Phase**: ${phase_num:-unknown}
- **Version**: ${version:-N/A}
- **Branch**: \`$branch_name\`

## Changes

\`\`\`
$commit_msg
\`\`\`

## Related Documents

- [PRD](../tasks/prds/$prd_num-prd-*.md)
- [Task List](../tasks/$prd_num-tasks-*.md)

## Checklist

- [x] Phase ${phase_num:-X} completed
- [x] Code implemented and documented
- [ ] CI tests passed (automated)
- [ ] Ready for merge

---

ğŸ¤– Auto-generated by [Claude Code](https://claude.com/claude-code) workflow
Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
EOF
}

# PR ìƒì„±
create_pr() {
    local pr_title="$1"
    local pr_body="$2"
    local base_branch="${3:-master}"

    log_info "PR ìƒì„± ì¤‘..."
    log_info "ì œëª©: $pr_title"

    # PR ìƒì„±
    local pr_number
    if pr_number=$(gh pr create --title "$pr_title" --body "$pr_body" --base "$base_branch" --json number --jq '.number' 2>&1); then
        log_success "PR #$pr_number ìƒì„± ì™„ë£Œ"

        # PR URL ì¶œë ¥
        local pr_url
        pr_url=$(gh pr view "$pr_number" --json url --jq '.url')
        log_info "PR URL: $pr_url"

        return 0
    else
        log_error "PR ìƒì„± ì‹¤íŒ¨: $pr_number"
        return 1
    fi
}

# ë©”ì¸ í•¨ìˆ˜
main() {
    local commit_hash="${1:-HEAD}"

    log_info "=== PR ìƒì„± í—¬í¼ ì‹œì‘ ==="

    # ì‚¬ì „ ê²€ì‚¬
    check_gh_cli
    check_git_repo

    # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
    local branch_name
    branch_name=$(git branch --show-current)
    log_info "í˜„ì¬ ë¸Œëœì¹˜: $branch_name"

    # feature/* ë¸Œëœì¹˜ í™•ì¸
    if [[ ! "$branch_name" =~ ^feature/ ]]; then
        log_warning "feature/* ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤."
        log_info "í˜„ì¬: $branch_name"
    fi

    # Phase ì™„ë£Œ ê°ì§€
    detect_phase_completion "$commit_hash"

    # JSON íŒŒì‹±
    local phase_num prd_num version commit_msg
    phase_num=$(jq -r '.phase_number' /tmp/phase_info.json)
    prd_num=$(jq -r '.prd_number' /tmp/phase_info.json)
    version=$(jq -r '.version' /tmp/phase_info.json)
    commit_msg=$(jq -r '.commit_message' /tmp/phase_info.json)

    # ê¸°ì¡´ PR í™•ì¸
    if check_existing_pr "$branch_name"; then
        log_info "ì´ë¯¸ PRì´ ì¡´ì¬í•˜ë¯€ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
        exit 0
    fi

    # PR ì œëª©/ë³¸ë¬¸ ìƒì„±
    local pr_title pr_body
    pr_title=$(generate_pr_title "$phase_num" "$prd_num" "$commit_msg")
    pr_body=$(generate_pr_body "$phase_num" "$prd_num" "$version" "$branch_name" "$commit_msg")

    # PR ìƒì„±
    if create_pr "$pr_title" "$pr_body" "master"; then
        log_success "=== PR ìƒì„± ì™„ë£Œ ==="
    else
        log_error "=== PR ìƒì„± ì‹¤íŒ¨ ==="
        exit 1
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"
